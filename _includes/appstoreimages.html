<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

{% if site.ios_app_id %}
<script>
$(function () {
  var apiURL = "https://itunes.apple.com/lookup?id={{ site.ios_app_id }}&country={{ site.ios_app_country }}&callback=?";

  // Prefer TestFlight if provided
  var testFlightUrl = "{{ site.testflight_public_link | default: '' }}".trim();

  $.getJSON(apiURL, function (json) {
    if (json.results && json.results.length) {
      var appInfo = json.results[0];

      // favicon
      $('link[rel="shortcut icon"]').attr("href", appInfo.artworkUrl512);

      // title
      var $pageTitle = $(".pageTitle");
      if ($.trim($pageTitle.text()).length === 0) $pageTitle.html(appInfo.trackName);

      // large icon
      var $appIconLarge = $(".appIconLarge");
      if (!$appIconLarge.attr("src")) $appIconLarge.attr("src", appInfo.artworkUrl512);

      // header icon
      var $appIconHeader = $(".headerIcon");
      if (!$appIconHeader.attr("src")) $appIconHeader.attr("src", appInfo.artworkUrl512);

      // names
      var $appName = $(".appName");
      if ($.trim($appName.text()).length === 0) $appName.html(appInfo.trackName);

      var $headerName = $(".headerName");
      if ($.trim($headerName.text()).length === 0) $headerName.html(appInfo.trackName);

      // price
      var $appPrice = $(".appPrice");
      if ($.trim($appPrice.text()).length === 0) $appPrice.html(appInfo.formattedPrice);

      // links
      var appStoreUrl = appInfo.trackViewUrl;

      if (testFlightUrl) {
        // Make TestFlight the primary CTA
        var $tf = $(".testFlightLink");
        if ($tf.length) {
          if (!$tf.attr("href")) $tf.attr("href", testFlightUrl);
          if ($.trim($tf.text()).length === 0) $tf.text("Join the beta on TestFlight");
          $tf.show();
        }

        // Keep App Store as secondary
        var $as = $(".appStoreLink");
        if ($as.length) {
          if (!$as.attr("href")) $as.attr("href", appStoreUrl);
          if ($.trim($as.text()).length === 0) $as.text("View on the App Store");
          $as.show();
        }
      } else {
        // No TestFlight link, fall back to App Store primary
        var $asOnly = $(".appStoreLink");
        if ($asOnly.length) {
          if (!$asOnly.attr("href")) $asOnly.attr("href", appStoreUrl);
          if ($.trim($asOnly.text()).length === 0) $asOnly.text("View on the App Store");
          $asOnly.show();
        }
        $(".testFlightLink").hide();
      }
    }
  });
});
</script>
{% endif %}
